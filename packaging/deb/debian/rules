#!/usr/bin/make -f

# Debian rules file for UnitMail
# See debhelper(7) and dh_* commands for documentation

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export PYBUILD_NAME = unitmail

# Python version
PYTHON3 = python3

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_clean:
	dh_auto_clean
	rm -rf build/ dist/ *.egg-info src/*.egg-info
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true

override_dh_auto_build:
	dh_auto_build
	$(PYTHON3) -m pip wheel --no-deps --wheel-dir=dist .

override_dh_auto_install:
	dh_auto_install
	# Install the package using pip
	$(PYTHON3) -m pip install --no-deps --prefix=/usr --root=$(CURDIR)/debian/unitmail dist/*.whl

	# Install desktop file
	install -D -m 644 packaging/appimage/unitmail.desktop \
		$(CURDIR)/debian/unitmail/usr/share/applications/unitmail.desktop

	# Install icon (if exists)
	if [ -f packaging/appimage/unitmail.png ]; then \
		install -D -m 644 packaging/appimage/unitmail.png \
			$(CURDIR)/debian/unitmail/usr/share/icons/hicolor/256x256/apps/unitmail.png; \
	fi

	# Install man page (if exists)
	if [ -f docs/unitmail.1 ]; then \
		install -D -m 644 docs/unitmail.1 \
			$(CURDIR)/debian/unitmail/usr/share/man/man1/unitmail.1; \
	fi

override_dh_auto_test:
	# Run tests if available
	if [ -d tests/unit ]; then \
		$(PYTHON3) -m pytest tests/unit/ -v || true; \
	fi

override_dh_python3:
	dh_python3 --shebang=/usr/bin/python3

override_dh_installchangelogs:
	dh_installchangelogs CHANGELOG.md || dh_installchangelogs

override_dh_installdocs:
	dh_installdocs README.md || dh_installdocs
